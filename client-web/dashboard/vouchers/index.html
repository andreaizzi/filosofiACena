<!DOCTYPE html>
<html>

<head>
    <title>Lista Buoni</title>
</head>

<body>
    <!-- Home button -->
    <div style="text-align: right; margin-top: 20px; ">
        <a href="../" class="header-button">Home</a>
    </div>

    <div class="rounded-box" id="vouchersList">
    </div>

    <link rel="stylesheet" href="/styles/style.css">

    <script src="/scripts/api.js"></script>
    <script src="/scripts/elements.js"></script>

    <script>
        const userId = localStorage.getItem('userId');

        if (!userId) {
            console.log('No userId found in localStorage. Redirecting to login.');
            window.location.href = '../login/';
        }

        getUser(userId)
            .then(user => {
                getVouchersForUser(userId).then(vouchers => {
                    const vouchersListDiv = document.getElementById('vouchersList');
                    vouchersListDiv.innerHTML = '';

                    if (vouchers.length === 0) {
                        const noVouchersMessage = document.createElement('p');
                        noVouchersMessage.innerText = 'Nessun buono trovato.';
                        vouchersListDiv.appendChild(noVouchersMessage);
                    } else {
                        vouchers.sort((a, b) => {
                            const dateA = new Date(a.creationDate.replace('[UTC]', ''));
                            const dateB = new Date(b.creationDate.replace('[UTC]', ''));
                            return dateB - dateA;
                        });

                        const table = createVouchersTable(vouchers);
                        vouchersListDiv.appendChild(table);
                    }
                }).catch(error => {
                    console.error('Error fetching vouchers:', error);
                    alert(error.message || 'Si è verificato un errore durante il caricamento dei buoni. Riprova più tardi.');
                    window.location.href = '../login/';
                });
            })
            .catch(error => {
                console.error('Stored userId is invalid. Redirecting to login.', error);
                localStorage.removeItem('userId');
                window.location.href = '../login/';
            });

    </script>
</body>

</html>